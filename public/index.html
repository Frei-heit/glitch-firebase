<html>
  <head>
    <script
      src="https://code.jquery.com/jquery-3.4.1.min.js"
      integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <div>
      <div id="match">
        „Éû„ÉÉ„ÉÅ„É≥„Ç∞<br />
        room<input type="text" name="room" id="room" /><br />
        pass<input type="text" name="pass" id="pass" />
        <input type="button" id="createRoom" value="ÈÉ®Â±ã„Çí‰Ωú„Çã" /><br /><br />
        <input type="button" id="joinRoom" value="ÈÉ®Â±ã„Å´ÂÖ•„Çã" />
      </div>
    </div>
    <div id="wait" style="display:none;">
      <div id="people"></div>
    </div>
    <div id="battle" style="display: none;">
      <div id="selectHand">
        <div id="shText"></div>
        <div id="pa" class="hand">
          üñê
        </div>
        <div id="gu" class="hand">
          ‚úä
        </div>
        <div id="ch" class="hand">
          ‚úåÔ∏è
        </div>
      </div>
    </div>

    <!-- Insert these scripts at the bottom of the HTML, but before you use any Firebase services -->

    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/6.2.0/firebase-app.js"></script>

    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/6.2.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/6.2.0/firebase-firestore.js"></script>

    <script type="text/javascript">
      function TKJP(data, user2){
        
      }
      function count(c){
        $("#shText").val("„Åò„ÇÉ„Çì„Åë„Çì "+c);
      }
      function janken(roomdb, data) {
        alert("battle start!");
        $("#wait").toggle();
        $("#battle").toggle();
        $("#shText").val("ÊúÄÂàù„ÅØ‚úä")
        var c = 3
        var countDown = setInterval(function(){
          if(c != 0){
            count(c);
            c -= 1;
          }else{
            clearInterval(countDown);
            if(data.p == 1){
              roomdb.update({
                user1: data
              }).then(function(){
                window.setTimeout(function(){
                  roomdb.get().then(function(doc){
                    var d = doc.data()
                    $("#selectHand").toggle();
                    battleFunc(data, d.user2);
                  }).catch(function(error){
                    
                  })
                })
              }).catch(function(error){
                
              })
            }else{
              
            }
          }
        }, 1000)
      }

      function create(db, user) {
        var room = $("#room").val();
        var pass = $("#pass").val();
        if (!room || !pass) {
          alert("input error");
          return;
        }
        var name = user.displayName;
        var data = { p: 1, name: name, hand: null, time: null };
        var roomdb = db.collection("room").doc(room);
        /*
        window.addEventListner(
          "beforeunload",
          function() {
            roomdb
              .delete()
              .then(function() {
                return;
              })
              .catch(function(error) {
                alert(error);
              });
          },
          false
        );*/
        roomdb
          .set({
            pass: pass,
            user1: data,
            user2: {},
            wait: []
          })
          .then(function() {
            alert("success");
            $("#match").toggle();
            $("#wait").toggle();
            var unsubscribe = roomdb.onSnapshot(function(doc) {
              let d = doc.data();
              if (d.wait[0]) {
                alert(JSON.stringify(d));
                $("#people").append(
                  "<input type='button' class='waitPlayer' value='" +
                    d.wait.pop() +
                    "' />"
                );
              } else {
                alert(JSON.stringify(d));
                alert("no wait");
              }
            });
            alert("snap ok");
            $(document).on("click", ".waitPlayer", function() {
              alert("click!!!!!");
              let name2 = $(this).val();
              if (window.confirm(name2 + "„Å®ÂØæÊà¶„Åó„Åæ„Åô„ÅãÔºü")) {
                unsubscribe();
                roomdb.update({ user2: { name: name2 } })
                  .then(function() {
                    alert("upsuc");
                    janken();
                  })
                  .catch(function(error) {
                    alert(error);
                    alert("error has occured. please retry.")
                    $(this).remove();
                  });
              } else {
                $(this).remove();
              }
            });
          })
          .catch(function(error) {
            alert(error);
          });
      }

      function join(db, user) {
        var room = $("#room").val();
        var pass = $("#pass").val();
        if (!room || !pass) {
          alert("input error");
          return;
        }
        var name = user.displayName;
        var data = { p: 2, name: name, hand: null, time: null };
        var roomdb = db.collection("room").doc(room);
        alert(name);
        roomdb.update({
          wait: firebase.firestore.FieldValue.arrayUnion(name)
        });
        $("#match").toggle();
        $("#wait").toggle();
        $("#people").val("wait now")
        alert("wait");
        var unsubscribe = roomdb.onSnapshot(function(doc) {
          var name2 = doc.data().user2.name;
          alert(name2);
          alert(name2 == name)
          if (name2 == name) {
            alert("up start")
            unsubscribe();
            roomdb
              .update({ user2: data })
              .then(function() {
                alert("upsuc2");
                janken();
              })
              .catch(function(error) {
                alert(error)
                alert("error has occured. please retry.")
            });
          } else if (!name2) {
          } else {
            alert("ÊãíÂê¶„Åï„Çå„Åæ„Åó„Åü„ÄÇ„ÇÑ„ÇäÁõ¥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
            return;
          }
        });
      }

      $(function() {
        //select Game
        var battleFunction = TKJP;
        
        var firebaseConfig = {
          apiKey: "AIzaSyDRJRC_2rt1BdDTQjtZaZOs7d4BHUfa7V0",
          authDomain: "glitch-48c07.firebaseapp.com",
          databaseURL: "https://glitch-48c07.firebaseio.com",
          projectId: "glitch-48c07",
          storageBucket: "glitch-48c07.appspot.com",
          appID: "1:866922273041:web:2d02ec91a5e0a790a414b0"
        };

        firebase.initializeApp(firebaseConfig);

        var provider = new firebase.auth.GoogleAuthProvider();
        var db = firebase.firestore();
        /*firebase
                .auth()
                .signInWithEmailAndPassword(email, password)
                .catch(function(error) {
                  // Handle Errors here.
                  var errorCode = error.code;
                  var errorMessage = error.m*/

        firebase.auth().onAuthStateChanged(function(user) {
          if (user) {
            alert(user.displayName);
            // User is signed in.
            $("#createRoom").on("click", function() {
              alert("click");
              create(db, user);
            });
            $("#joinRoom").on("click", function() {
              alert("click2");
              join(db, user);
            });
            return;
          } else {
            alert("„Åì„ÅÆ„Ç≤„Éº„É†„ÅØGoogle„Å∏„ÅÆ„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ");
            firebase
              .auth()
              .setPersistence(firebase.auth.Auth.Persistence.LOCAL)
              .then(function() {
                // Existing and future Auth states are now persisted in the current
                // session only. Closing the window would clear any existing state even
                // if a user forgets to sign out.
                // ...
                // New sign-in will be persisted with session persistence.
                return firebase.auth().signInWithRedirect(provider);
              })
              .catch(function(error) {
                // Handle Errors here.
                var errorCode = error.code;
                var errorMessage = error.message;
              });
          }
        });

        /*function auth() {
                alert("„Åì„ÅÆ„Ç¢„Éó„É™„ÅØGoogle„Åß„ÅÆ„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Å®„Å™„Çä„Åæ„Åô„ÄÇ");
                firebase
                  .au
                  .setPersistence(firebase.auth.Auth.Persistence.LOCAL)
                  .then(function() {})
                  .catch(function(error) {
                    // Handle Errors here.
                    var errorCode = error.code;
                    var errorMessage = error.message;
                  });
                firebase
                  .auth()
                  .signInWithPopup(provider)
                  .then(function(result) {
                    // This gives you a Google Access Token. You can use it to access the Google API.
                    var token = result.credential.accessToken;
                    // The signed-in user info.
                    var user = result.user;

                    return user.displayName;
                  })
                  .catch(function(error) {
                    alert("alal");
                    return;
                  });
              }*/

        /*firebase
                .auth()
                .getRedirectResult()
                .then(function(result) {
                  if (result.credential) {
                    // This gives you a Google Access Token. You can use it to access the Google API.
                    var token = result.credential.accessToken;
                    // ...
                  }
                  // The signed-in user info.
                  var user = result.user;
                  name = user.displayName;
                })
                .catch(function(error) {
                  // Handle Errors here.
                  var errorCode = error.code;
                  var errorMessage = error.message;
                  // The email of the user's account used.
                  var email = error.email;
                  // The firebase.auth.AuthCredential type that was used.
                  var credential = error.credential;
                  // ...
                });

              function c() {
                alert("cccccccc");
              }*/
        /*
              function onclk() {
                alert("clcik");
                var room = $("#room").val();
                var pass = $("#pass").val();
                if (!room || !pass) {
                  alert("input error");
                  return;
                }
                var user = { p: 1, name: name, hand: null, time: null };
                var roomdb = db.collection("room").doc(room);
                window.addEventListner(
                  "beforeunload",
                  function() {
                    roomdb
                      .delete()
                      .then(function() {
                        return;
                      })
                      .catch(function(error) {
                        alert(error);
                      });
                  },
                  false
                );
                roomdb
                  .set({
                    pass: pass,
                    user1: user,
                    user2: null,
                    wait: []
                  })
                  .then(function() {
                    alert("success");
                  })
                  .catch(function(error) {
                    alert(error);
                  });
              }
              */
      });
    </script>
  </body>
</html>
