<html>
  <head>
    <script
      src="https://code.jquery.com/jquery-3.4.1.min.js"
      integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <div>
      <div id="match">
        マッチング<br />
        room<input type="text" name="room" id="room" /><br />
        pass<input type="text" name="pass" id="pass" />
        <input type="button" id="createRoom" value="部屋を作る" /><br /><br />
        <input type="button" id="joinRoom" value="部屋に入る" />
      </div>
    </div>
    <div id="wait1" style="display:noen;">
      <div id="people"></div>
    </div>
    <div id="battle" style="display: none;">
      対戦
    </div>

    <!-- Insert these scripts at the bottom of the HTML, but before you use any Firebase services -->

    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/6.2.0/firebase-app.js"></script>

    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/6.2.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/6.2.0/firebase-firestore.js"></script>

    <script type="text/javascript">
      function battle(){
        alert("battle start!")
      }

      function create(db, user) {
        var room = $("#room").val();
        var pass = $("#pass").val();
        if (!room || !pass) {
          alert("input error");
          return;
        }
        var name = user.displayName;
        var data = { p: 1, name: name, hand: null, time: null };
        var roomdb = db.collection("room").doc(room);
        /*
        window.addEventListner(
          "beforeunload",
          function() {
            roomdb
              .delete()
              .then(function() {
                return;
              })
              .catch(function(error) {
                alert(error);
              });
          },
          false
        );*/
        roomdb
          .set({
            pass: pass,
            user1: data,
            user2: {},
            wait: []
          })
          .then(function() {
            alert("success");
            $("#match").css("display:noen;");
            $("#wait1").css("display:block;");
            roomdb.onSnapshot(function(doc){
              if(doc.exists && doc.data().wait[0]){
                $("#people").append("<div class='waitPlayer'>"+doc.data().wait.pop()+"<div>")
              }else{
                alert(JSON.stringify(doc.data()))
                alert("doc no exist or no wait")
              }
            });
            alert("snap ok")
            $(".waitPlayer").on("click",function(){
              alert("click!!!!!")
              if(window.confirm(this.val()+"と対戦しますか？")){
                db.update({user2: {name:this.val()}}).then(function(){
                  alert("upsuc")
                  unsubscribe();
                  battle()
                }).catch(function(error){
                  alert(error);
                  this.remove();
                });
              }else{
                this.remove();
              }
            })
          })
          .catch(function(error) {
            alert(error);
          });
      }

      function join(db, user){
        var room = $("#room").val();
        var pass = $("#pass").val();
        if(!room || !pass){
          alert("input error");
          return;
        }
        var name = user.displayName;
        var data = {p:2, name:name, hand:null, time:null}
        var roomdb = db.collection("room").doc(room);
        alert(name)
        roomdb.update({
          wait: firebase.firestore.FieldValue.arrayUnion(name)
        });
        alert("wait")
        roomdb.onSnapshot(function(doc){
          var name2 = doc.data().user2.name;
          alert(name2)
          if(name2 == name){
            roomdb.update({user2:user}).then(function(){
              alert("upsuc2")
              unsubscribed();
              battle();
            }).catch(function(error){

            })
          }else if(!name2){

          }else{
            alert("拒否されました。やり直してください。");
            return;
          }
        })
      }

      $(function() {
        var firebaseConfig = {
          apiKey: "AIzaSyDRJRC_2rt1BdDTQjtZaZOs7d4BHUfa7V0",
          authDomain: "glitch-48c07.firebaseapp.com",
          databaseURL: "https://glitch-48c07.firebaseio.com",
          projectId: "glitch-48c07",
          storageBucket: "glitch-48c07.appspot.com",
          appID: "1:866922273041:web:2d02ec91a5e0a790a414b0"
        };

        firebase.initializeApp(firebaseConfig);

        var provider = new firebase.auth.GoogleAuthProvider();
        var db = firebase.firestore();
        /*firebase
                .auth()
                .signInWithEmailAndPassword(email, password)
                .catch(function(error) {
                  // Handle Errors here.
                  var errorCode = error.code;
                  var errorMessage = error.m*/

        firebase.auth().onAuthStateChanged(function(user) {
          if (user) {
            alert(user.displayName)
            // User is signed in.
            $("#createRoom").on("click",function(){
              alert("click")
              create(db, user);
            });
            $("#joinRoom").on("click",function(){
              alert("click2")
              join(db, user);
            });
            return;
          } else {
            alert("このゲームはGoogleへのログインが必要です。");
            firebase
              .auth()
              .setPersistence(firebase.auth.Auth.Persistence.LOCAL)
              .then(function() {
                // Existing and future Auth states are now persisted in the current
                // session only. Closing the window would clear any existing state even
                // if a user forgets to sign out.
                // ...
                // New sign-in will be persisted with session persistence.
                return firebase.auth().signInWithRedirect(provider);
              })
              .catch(function(error) {
                // Handle Errors here.
                var errorCode = error.code;
                var errorMessage = error.message;
              });
          }
        });

        /*function auth() {
                alert("このアプリはGoogleでのログインが必要となります。");
                firebase
                  .au
                  .setPersistence(firebase.auth.Auth.Persistence.LOCAL)
                  .then(function() {})
                  .catch(function(error) {
                    // Handle Errors here.
                    var errorCode = error.code;
                    var errorMessage = error.message;
                  });
                firebase
                  .auth()
                  .signInWithPopup(provider)
                  .then(function(result) {
                    // This gives you a Google Access Token. You can use it to access the Google API.
                    var token = result.credential.accessToken;
                    // The signed-in user info.
                    var user = result.user;

                    return user.displayName;
                  })
                  .catch(function(error) {
                    alert("alal");
                    return;
                  });
              }*/

        /*firebase
                .auth()
                .getRedirectResult()
                .then(function(result) {
                  if (result.credential) {
                    // This gives you a Google Access Token. You can use it to access the Google API.
                    var token = result.credential.accessToken;
                    // ...
                  }
                  // The signed-in user info.
                  var user = result.user;
                  name = user.displayName;
                })
                .catch(function(error) {
                  // Handle Errors here.
                  var errorCode = error.code;
                  var errorMessage = error.message;
                  // The email of the user's account used.
                  var email = error.email;
                  // The firebase.auth.AuthCredential type that was used.
                  var credential = error.credential;
                  // ...
                });

              function c() {
                alert("cccccccc");
              }*/
        /*
              function onclk() {
                alert("clcik");
                var room = $("#room").val();
                var pass = $("#pass").val();
                if (!room || !pass) {
                  alert("input error");
                  return;
                }
                var user = { p: 1, name: name, hand: null, time: null };
                var roomdb = db.collection("room").doc(room);
                window.addEventListner(
                  "beforeunload",
                  function() {
                    roomdb
                      .delete()
                      .then(function() {
                        return;
                      })
                      .catch(function(error) {
                        alert(error);
                      });
                  },
                  false
                );
                roomdb
                  .set({
                    pass: pass,
                    user1: user,
                    user2: null,
                    wait: []
                  })
                  .then(function() {
                    alert("success");
                  })
                  .catch(function(error) {
                    alert(error);
                  });
              }
              */
      });
    </script>
  </body>
</html>
