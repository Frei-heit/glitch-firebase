<html>
  <head>
    <script
      src="https://code.jquery.com/jquery-3.4.1.min.js"
      integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <div>
      <div id="match">
        マッチング<br />
        room<input type="text" name="room" id="room" /><br />
        pass<input type="text" name="pass" id="pass" />
        <input
          type="button"
          id="createRoom"
          value="部屋を作る"
          onclick="c()"
        /><br /><br />
        <div id="joinRoom">
          部屋に入る
        </div>
      </div>
    </div>
    <div style="display: none;">
      対戦
    </div>

    <!-- Insert these scripts at the bottom of the HTML, but before you use any Firebase services -->

    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/6.2.0/firebase-app.js"></script>

    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/6.2.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/6.2.0/firebase-firestore.js"></script>

    <script type="text/javascript">
      $(function() {
        var firebaseConfig = {
          apiKey: "AIzaSyDRJRC_2rt1BdDTQjtZaZOs7d4BHUfa7V0",
          authDomain: "glitch-48c07.firebaseapp.com",
          databaseURL: "https://glitch-48c07.firebaseio.com",
          projectId: "glitch-48c07",
          storageBucket: "glitch-48c07.appspot.com",
          appID: "1:866922273041:web:2d02ec91a5e0a790a414b0"
        };

        firebase.initializeApp(firebaseConfig);
        var provider = new firebase.auth.GoogleAuthProvider();
        var db = firebase.firestore();

        /*function auth() {
          alert("このアプリはGoogleでのログインが必要となります。");
          firebase
            .auth()
            .setPersistence(firebase.auth.Auth.Persistence.LOCAL)
            .then(function() {})
            .catch(function(error) {
              // Handle Errors here.
              var errorCode = error.code;
              var errorMessage = error.message;
            });
          firebase
            .auth()
            .signInWithPopup(provider)
            .then(function(result) {
              // This gives you a Google Access Token. You can use it to access the Google API.
              var token = result.credential.accessToken;
              // The signed-in user info.
              var user = result.user;

              return user.displayName;
            })
            .catch(function(error) {
              alert("alal");
              return;
            });
        }*/
        function authRD() {
          
          firebase.auth().signInWithRedirect(provider);
        }
        firebase
          .auth()
          .getRedirectResult()
          .then(function(result) {
            if (result.credential) {
              // This gives you a Google Access Token. You can use it to access the Google API.
              var token = result.credential.accessToken;
              // ...
            }
            // The signed-in user info.
            var user = result.user;
            name = user.displayName;
          })
          .catch(function(error) {
            // Handle Errors here.
            var errorCode = error.code;
            var errorMessage = error.message;
            // The email of the user's account used.
            var email = error.email;
            // The firebase.auth.AuthCredential type that was used.
            var credential = error.credential;
            // ...
          });
        var name;
        firebase.auth().onAuthStateChanged(function(user) {
          if (user) {
            name = user.displayName;
          } else {
          }
        });
        if (!name) {
          authRD();
        }
        alert(name);
        alert(name);

        function c() {
          alert("cccccccc");
        }
        function onclick() {
          alert("clcik");
          var room = $("#room").val();
          var pass = $("#pass").val();
          if (!room || !pass) {
            alert("input error");
            return;
          }
          var user = { p: 1, name: name, hand: null, time: null };
          var roomdb = db.collection("room").doc(room);
          window.addEventListner(
            "beforeunload",
            function() {
              roomdb
                .delete()
                .then(function() {
                  return;
                })
                .catch(function(error) {
                  alert(error);
                });
            },
            false
          );
          roomdb
            .set({
              pass: pass,
              user1: user,
              user2: null,
              wait: []
            })
            .then(function() {
              alert("success");
            })
            .catch(function(error) {
              alert(error);
            });
        }
      });
    </script>
  </body>
</html>
